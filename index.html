<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bootstrap Dropdown-1</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="style.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</head>

<body class="d-flex justify-content-center align-items-center vh-100">
    <div class="mt-5 text-center container-style">
        <h2 class="mt-2 title"> TTC Times </h2>
        <!-- Dropdown Button -->
        <div class="dropdown mt-5">
            <label for="bnum"> Bus# : &nbsp; &nbsp;</label>
            <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownBusButton" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
                Select your Bus
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="dropdownBusMenu">
                <!-- Dynamic dropdown items will be added here by JavaScript -->
            </div>
        </div> <br> <br>
        <div class="dropdown">
            <label for="stops"> Stops : &nbsp;</label>
            <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownStopSelected"
                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Select your Stop
            </button>
            <div class="dropdown-menu mt-5" aria-labelledby="dropdownMenuButton" id="dropdownStopMenu">
                <!-- Dynamic dropdown items will be added here by JavaScript -->
            </div>
        </div> <br> <br>
        <ul id="lblTime" class="ul-time"></ul>
    </div>
    <!-- Bootstrap and jQuery JS -->

    <script>

        //Create Bus Dropdown-
        function busDropdown(buses) {
            let route = buses.route;
            const dropdownBusMenu = document.getElementById("dropdownBusMenu");
            for (let bus of route) {
                const dropdownButton = document.createElement('button');            // Create <button> element
                dropdownButton.classList.add('dropdown-item');                      // Add Bootstrap class for CSS 
                dropdownButton.textContent = bus.title;                              // Set 'name' property
                dropdownButton.type = 'button';                                     // Set the 'type' property
                dropdownButton.addEventListener('click', () => onBusSelected(bus));  // Add the Event Listener to the Dropdown Button
                dropdownBusMenu.appendChild(dropdownButton);                        // Append item to dropdown
            }
        }

        //Fetching data from the API-
        async function fetchBuses() {
            const res = await fetch('https://webservices.nextbus.com/service/publicJSONFeed?command=routeList&a=ttc');
            const buses = await res.json();
            busDropdown(buses);
        }
        fetchBuses();

        //Create Stop Dropdown-
        function stopDropdown(bus, stops) { // stops= stops.route.stop;
            let stopsRouteStop = stops.route.stop;
            for (let stop of stopsRouteStop) {
                const dropdownStopButton = document.createElement('button');
                dropdownStopButton.classList.add('dropdown-item');
                dropdownStopButton.textContent = stop.title;
                dropdownStopButton.type = 'button';
                const stopId = stop.stopId;
                const busTag = bus.tag;
                dropdownStopButton.addEventListener('click', () => onStopSelected(stop, busTag));
                dropdownStopMenu.appendChild(dropdownStopButton);
            }
        }

        //when 'Bus' is selected
        async function onBusSelected(bus) {
            const res = await fetch('https://webservices.nextbus.com/service/publicJSONFeed?command=routeConfig&a=ttc&r=' + bus.tag);
            const stops = await res.json();// the 'stops' here is only valid for the this function- scope is limited for this function
            const dropdownBusButton = document.getElementById("dropdownBusButton"); // creating a variable to show the selected Bus option
            dropdownBusButton.textContent = bus.title;
            const dropdownStopMenu = document.getElementById("dropdownStopMenu");
            while (dropdownStopMenu.firstChild) {
                dropdownStopMenu.removeChild(dropdownStopMenu.firstChild);
            }
            stopDropdown(bus, stops);
        }

        //Create Time Dropdown-
        function showTime(timesResult) {
            const lblTime = document.getElementById("lblTime")            // Creating a variable to show the 'Time' 
            const times = timesResult.predictions.direction.prediction;
            while (lblTime.firstChild) {
                lblTime.removeChild(lblTime.firstChild);
            }
            for (let time of times) {
                const listItem = document.createElement('li');        // Loop throught the bus times & create list items
                const mins = time.minutes + " minutes";
                listItem.textContent = mins;
                lblTime.appendChild(listItem);
                listItem.classList.add('list');
            }
        }

        //when 'Stop' is selected
        async function onStopSelected(stop, tag) {
            const dropdownStopSelected = document.getElementById("dropdownStopSelected"); // creating a variable to show the selected Bus option
            dropdownStopSelected.textContent = stop.title;
            const res = await fetch('https://retro.umoiq.com/service/publicJSONFeed?command=predictions&a=ttc&stopId=' + stop.stopId + '&routeTag=' + tag);
            const times = await res.json();// the 'times' here is only valid for the this function- scop eis limited for this function
            showTime(times);
        }

    </script>
</body>

</html>